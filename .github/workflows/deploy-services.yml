name: Deploy Services Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: europe-west1-docker.pkg.dev
  AR_REPO: services

concurrency:
  group: deploy-services-${{ github.ref }}
  cancel-in-progress: false

jobs:
  infra-core:
    name: Deploy Core Infrastructure
    runs-on: ubuntu-latest
    outputs:
      terraform-outputs: ${{ steps.tf-outputs.outputs.json }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy Core Infrastructure
        working-directory: infra/terraform/environments/dev
        run: |
          # Initialize Terraform
          terraform init

          # Plan core infrastructure
          terraform plan \
            -target=module.pubsub \
            -target=module.secrets \
            -target=module.logging \
            -target=google_firestore_database.database \
            -out=core-tfplan

          # Apply core infrastructure
          terraform apply -auto-approve core-tfplan

      - name: Export Terraform Outputs
        id: tf-outputs
        working-directory: infra/terraform/environments/dev
        run: |
          echo "json=$(terraform output -json)" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Service
    runs-on: ubuntu-latest
    needs: infra-core
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        service:
          - svc-authz
          - svc-shops
          - svc-requests
          - svc-preview
          - svc-ia-diff
          - svc-quality
          - svc-billing
          - svc-notify
          - svc-admin
          - api-gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.1.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library dependencies
        run: pnpm --filter=@hyperush/lib-otel build

      - name: Lint and build service
        run: |
          pnpm --filter=@hyperush/${{ matrix.service }} lint || echo "Warning: Lint step failed"
          pnpm --filter=@hyperush/${{ matrix.service }} build

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and push Docker image
        run: |
          IMAGE_URI="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }}"
          IMAGE_URI_LATEST="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ matrix.service }}:latest"

          docker build \
            --file packages/docker/node-pnpm.Dockerfile \
            --build-arg SERVICE=${{ matrix.service }} \
            --tag "$IMAGE_URI" \
            --tag "$IMAGE_URI_LATEST" \
            .

          docker push "$IMAGE_URI"
          docker push "$IMAGE_URI_LATEST"

          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy service with Terraform
        working-directory: infra/terraform/environments/dev
        env:
          TF_VAR_svc_authz_image: ${{ matrix.service == 'svc-authz' && env.IMAGE_URI || '' }}
          TF_VAR_svc_shops_image: ${{ matrix.service == 'svc-shops' && env.IMAGE_URI || '' }}
          TF_VAR_svc_requests_image: ${{ matrix.service == 'svc-requests' && env.IMAGE_URI || '' }}
          TF_VAR_svc_preview_image: ${{ matrix.service == 'svc-preview' && env.IMAGE_URI || '' }}
          TF_VAR_svc_ia_diff_image: ${{ matrix.service == 'svc-ia-diff' && env.IMAGE_URI || '' }}
          TF_VAR_svc_quality_image: ${{ matrix.service == 'svc-quality' && env.IMAGE_URI || '' }}
          TF_VAR_svc_billing_image: ${{ matrix.service == 'svc-billing' && env.IMAGE_URI || '' }}
          TF_VAR_svc_notify_image: ${{ matrix.service == 'svc-notify' && env.IMAGE_URI || '' }}
          TF_VAR_svc_admin_image: ${{ matrix.service == 'svc-admin' && env.IMAGE_URI || '' }}
          TF_VAR_api_gateway_image: ${{ matrix.service == 'api-gateway' && env.IMAGE_URI || '' }}
        run: |
          # Initialize Terraform
          terraform init

          # Plan deployment for this specific service
          terraform plan -target=module.${{ matrix.service }} -out=service-tfplan

          # Apply the plan
          terraform apply -auto-approve service-tfplan

      - name: Get service URL and health check
        working-directory: infra/terraform/environments/dev
        run: |
          # Get service URL
          SERVICE_URLS=$(terraform output -json service_urls)
          SERVICE_URL=$(echo "$SERVICE_URLS" | jq -r '."${{ matrix.service }}"')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "Service URL: $SERVICE_URL"

          # Health check with retry
          echo "Checking health of ${{ matrix.service }} at $SERVICE_URL"

          for i in {1..30}; do
            if curl -fsS "$SERVICE_URL/healthz" --max-time 10; then
              echo "âœ… Health check passed for ${{ matrix.service }}"
              exit 0
            fi
            echo "Health check attempt $i/30 failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed for ${{ matrix.service }} after 30 attempts"
          exit 1

  smoke-test:
    name: Smoke Tests & Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Generate Service Summary
        working-directory: infra/terraform/environments/dev
        run: |
          terraform init

          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY

          SERVICE_URLS=$(terraform output -json service_urls)

          for service in svc-authz svc-shops svc-requests svc-preview svc-ia-diff svc-quality svc-billing svc-notify svc-admin api-gateway; do
            url=$(echo "$SERVICE_URLS" | jq -r ".[\"$service\"]")
            if curl -fsS "$url/healthz" --max-time 5 >/dev/null 2>&1; then
              status="âœ… Healthy"
            else
              status="âŒ Unhealthy"
            fi
            echo "| $service | $url | $status |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload Service URLs
        uses: actions/upload-artifact@v4
        with:
          name: service-urls
          path: |
            infra/terraform/environments/dev/terraform.tfstate
