name: Deploy Services Matrix

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-matrix-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: europe-west1-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'hyperush-dev-250930115246' }}
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}

jobs:
  infra-core:
    name: Deploy Core Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Verify Cloud Build SA Permissions
        run: |
          echo "ðŸ” Verifying Cloud Build service account permissions..."
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectNumber)")
          CLOUD_BUILD_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"

          echo "Cloud Build SA: $CLOUD_BUILD_SA"
          gcloud artifacts repositories add-iam-policy-binding services \
            --location="${{ env.REGION }}" \
            --member="serviceAccount:${CLOUD_BUILD_SA}" \
            --role="roles/artifactregistry.writer" || echo "âš ï¸ Could not add permissions"

      - name: Deploy Core Infrastructure
        working-directory: infra/terraform/environments/dev
        env:
          TF_VAR_enable_metrics: false
          TF_VAR_enable_error_sink: false
        run: |
          terraform init -lock-timeout=10m
          terraform plan -lock-timeout=10m -out=core-tfplan
          terraform apply -auto-approve -lock-timeout=10m core-tfplan

  deploy:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: infra-core
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        service:
          - svc-authz
          - svc-shops
          - svc-requests
          - svc-preview
          - svc-ia-diff
          - svc-quality
          - svc-billing
          - svc-notify
          - svc-admin
          - api-gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Pull Base Image
        run: docker pull europe-west1-docker.pkg.dev/hyperush-dev-250930115246/services/base:latest

      - name: Local Smoke Test (BLOCKING)
        id: smoke
        run: |
          echo "ðŸ”¨ Building service image locally for smoke test..."
          docker build \
            -f packages/docker/service.Dockerfile \
            --build-arg SERVICE=${{ matrix.service }} \
            --build-arg BASE_IMAGE=europe-west1-docker.pkg.dev/hyperush-dev-250930115246/services/base:latest \
            -t smoketest:${{ github.sha }}-${{ matrix.service }} \
            .

          echo "ðŸ§ª Running smoke test..."
          chmod +x scripts/smoke.sh
          if ./scripts/smoke.sh smoketest:${{ github.sha }}-${{ matrix.service }}; then
            echo "âœ… SMOKE TEST PASSED"
          else
            echo "âŒ SMOKE TEST FAILED - Container failed to start or respond to /healthz"
            exit 1
          fi
          echo "smoke_passed=true" >> $GITHUB_OUTPUT

      - name: Build and Push Service Image via Cloud Build
        if: steps.smoke.outputs.smoke_passed == 'true'
        id: build
        run: |
          IMAGE_SHA="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ matrix.service }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ matrix.service }}:latest"

          cat > /tmp/cloudbuild.yaml <<'EOF'
          steps:
            - name: 'gcr.io/cloud-builders/docker'
              args:
                - 'build'
                - '-f'
                - 'packages/docker/service.Dockerfile'
                - '--build-arg'
                - 'SERVICE=${_SERVICE}'
                - '--build-arg'
                - 'BASE_IMAGE=${_BASE_IMAGE}'
                - '-t'
                - '${_IMAGE_SHA}'
                - '-t'
                - '${_IMAGE_LATEST}'
                - '.'
          images:
            - '${_IMAGE_SHA}'
            - '${_IMAGE_LATEST}'
          options:
            logging: CLOUD_LOGGING_ONLY
          EOF

          echo "ðŸ“¦ Submitting Cloud Build..."
          BUILD_ID=$(gcloud builds submit . \
            --region=${{ env.REGION }} \
            --config=/tmp/cloudbuild.yaml \
            --substitutions=_SERVICE=${{ matrix.service }},_IMAGE_SHA="${IMAGE_SHA}",_IMAGE_LATEST="${IMAGE_LATEST}",_BASE_IMAGE="europe-west1-docker.pkg.dev/hyperush-dev-250930115246/services/base:latest" \
            --format="value(id)")

          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "â³ Build ID: $BUILD_ID"

          # Wait for build (max 10min)
          timeout=600
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            STATUS=$(gcloud builds describe "$BUILD_ID" --region=${{ env.REGION }} --format="value(status)")
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Build SUCCESS"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build FAILED: $STATUS"
              gcloud builds log "$BUILD_ID" --region=${{ env.REGION }} | tail -100
              exit 1
            fi
            sleep 10
            elapsed=$((elapsed + 10))
          done

          # Get digest
          DIGEST=$(gcloud builds describe "$BUILD_ID" --region=${{ env.REGION }} --format="value(results.images[0].digest)")
          IMAGE_DIGEST="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ matrix.service }}@${DIGEST}"

          echo "IMAGE_URI_DIGEST=$IMAGE_DIGEST" >> $GITHUB_ENV
          echo "ðŸ“¦ Image: $IMAGE_DIGEST"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy Service with Terraform
        working-directory: infra/terraform/services/${{ matrix.service }}
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_runtime_service_account: runtime-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
          TF_VAR_image: ${{ env.IMAGE_URI_DIGEST }}
        run: |
          terraform init -lock-timeout=10m
          terraform plan -lock-timeout=10m -out=service-tfplan
          terraform apply -auto-approve -lock-timeout=10m service-tfplan

      - name: Get Service URL
        working-directory: infra/terraform/services/${{ matrix.service }}
        run: |
          SERVICE_URL=$(terraform output -raw service_url 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            SERVICE_URL=$(gcloud run services describe ${{ matrix.service }} \
              --region=${{ env.REGION }} \
              --format="value(status.url)")
          fi
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "ðŸŒ Service URL: $SERVICE_URL"

      - name: Health Check (Single Attempt)
        run: |
          echo "ðŸ¥ Health checking ${{ env.SERVICE_URL }}/healthz"
          if curl -fsS "${{ env.SERVICE_URL }}/healthz" --max-time 10; then
            echo "âœ… Health check PASSED"
          else
            echo "âŒ Health check FAILED"
            echo "Checking Cloud Run service status..."
            gcloud run services describe ${{ matrix.service }} \
              --region=${{ env.REGION }} \
              --format="yaml(status.conditions)"
            exit 1
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate Service Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Health Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|---------------|" >> $GITHUB_STEP_SUMMARY

          for service in svc-authz svc-shops svc-requests svc-preview svc-ia-diff svc-quality svc-billing svc-notify svc-admin api-gateway; do
            url=$(gcloud run services describe $service \
              --region=${{ env.REGION }} \
              --format="value(status.url)" 2>/dev/null || echo "Not deployed")

            if [[ "$url" != "Not deployed" ]] && curl -fsS "$url/healthz" --max-time 5 >/dev/null 2>&1; then
              health_status="âœ… Healthy"
            elif [[ "$url" != "Not deployed" ]]; then
              health_status="âŒ Unhealthy"
            else
              health_status="â³ Not deployed"
            fi

            echo "| $service | $url | $health_status |" >> $GITHUB_STEP_SUMMARY
          done
