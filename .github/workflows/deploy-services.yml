name: Deploy Services Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-services-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: europe-west1-docker.pkg.dev
  AR_REPO: services

jobs:
  infra-core:
    name: Deploy Core Infrastructure
    runs-on: ubuntu-latest
    outputs:
      terraform-outputs: ${{ steps.tf-outputs.outputs.json }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy Core Infrastructure
        working-directory: infra/terraform/environments/dev
        run: |
          terraform init -lock-timeout=5m
          terraform plan \
            -target=module.pubsub \
            -target=module.secrets \
            -target=module.logging \
            -lock-timeout=5m \
            -out=core-tfplan
          terraform apply -auto-approve -lock-timeout=5m core-tfplan

      - name: Export Terraform Outputs
        id: tf-outputs
        working-directory: infra/terraform/environments/dev
        run: |
          echo "json=$(terraform output -json)" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Service
    runs-on: ubuntu-latest
    needs: infra-core
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        service:
          - svc-authz
          - svc-shops
          - svc-requests
          - svc-preview
          - svc-ia-diff
          - svc-quality
          - svc-billing
          - svc-notify
          - svc-admin
          - api-gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.1.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build library dependencies
        run: pnpm --filter=@hyperush/lib-otel build

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        run: |
          IMAGE_URI="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ matrix.service }}:${{ github.sha }}"
          IMAGE_URI_LATEST="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ matrix.service }}:latest"

          echo "Building and pushing: $IMAGE_URI"

          docker buildx build \
            --platform linux/amd64 \
            --file packages/docker/node-pnpm.Dockerfile \
            --build-arg SERVICE=${{ matrix.service }} \
            --tag "$IMAGE_URI" \
            --tag "$IMAGE_URI_LATEST" \
            --push \
            .

          echo "Getting image digest..."
          DIGEST=$(docker buildx imagetools inspect "$IMAGE_URI" --format '{{ .Manifest.Digest }}')
          echo "Image digest: $DIGEST"

          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "IMAGE_DIGEST=$DIGEST" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy service with Terraform
        working-directory: infra/terraform/environments/dev
        run: |
          # Export global TF variables
          export TF_VAR_project_id="${{ vars.GCP_PROJECT_ID }}"
          export TF_VAR_region="europe-west1"
          export TF_VAR_runtime_service_account="runtime-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

          # Set TF variable for current service only (avoid injecting empty vars for other services)
          case "${{ matrix.service }}" in
            svc-authz)    export TF_VAR_svc_authz_image="$IMAGE_URI" ;;
            svc-shops)    export TF_VAR_svc_shops_image="$IMAGE_URI" ;;
            svc-requests) export TF_VAR_svc_requests_image="$IMAGE_URI" ;;
            svc-preview)  export TF_VAR_svc_preview_image="$IMAGE_URI" ;;
            svc-ia-diff)  export TF_VAR_svc_ia_diff_image="$IMAGE_URI" ;;
            svc-quality)  export TF_VAR_svc_quality_image="$IMAGE_URI" ;;
            svc-billing)  export TF_VAR_svc_billing_image="$IMAGE_URI" ;;
            svc-notify)   export TF_VAR_svc_notify_image="$IMAGE_URI" ;;
            svc-admin)    export TF_VAR_svc_admin_image="$IMAGE_URI" ;;
            api-gateway)  export TF_VAR_api_gateway_image="$IMAGE_URI" ;;
            *) echo "Unknown service: ${{ matrix.service }}"; exit 1 ;;
          esac

          echo "Deploying ${{ matrix.service }} with image: $IMAGE_URI"

          terraform init -lock-timeout=5m
          terraform plan -target=module.${{ matrix.service }} -lock-timeout=5m -out=service-tfplan
          terraform apply -auto-approve -lock-timeout=5m service-tfplan

      - name: Get service URL and health check
        working-directory: infra/terraform/environments/dev
        run: |
          # Get service URL
          SERVICE_URLS=$(terraform output -json service_urls)
          SERVICE_URL=$(echo "$SERVICE_URLS" | jq -r '."${{ matrix.service }}"')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "Service URL: $SERVICE_URL"

          # Health check with 30 retries
          echo "Checking health of ${{ matrix.service }} at $SERVICE_URL"

          for i in {1..30}; do
            if curl -fsS "$SERVICE_URL/healthz" --max-time 10; then
              echo "âœ… Health check passed for ${{ matrix.service }}"
              exit 0
            fi
            echo "Health check attempt $i/30 failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed for ${{ matrix.service }} after 30 attempts"
          exit 1

  smoke-test:
    name: Smoke Tests & Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Generate Service Summary
        working-directory: infra/terraform/environments/dev
        run: |
          # Install jq
          sudo apt-get update && sudo apt-get install -y jq

          # Initialize Terraform (read-only)
          terraform init -lock-timeout=5m

          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY

          SERVICE_URLS=$(terraform output -json service_urls)

          for service in svc-authz svc-shops svc-requests svc-preview svc-ia-diff svc-quality svc-billing svc-notify svc-admin api-gateway; do
            url=$(echo "$SERVICE_URLS" | jq -r ".[\"$service\"]")
            if curl -fsS "$url/healthz" --max-time 5 >/dev/null 2>&1; then
              status="âœ… Healthy"
            else
              status="âŒ Unhealthy"
            fi
            echo "| $service | $url | $status |" >> $GITHUB_STEP_SUMMARY
          done
