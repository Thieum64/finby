name: OIDC Auth Smoke (GCP)
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: [".github/workflows/oidc-auth-smoke.yml"]
permissions:
  id-token: write
  contents: read
env:
  PROJECT_ID: hyperush-dev-250930115246
  PROJECT_NUMBER: 443512026283
  REGION: europe-west1
  DEPLOY_SA: deploy-sa@hyperush-dev-250930115246.iam.gserviceaccount.com
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Auth to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ env.DEPLOY_SA }}
      - name: Install gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - name: Show identity
        run: gcloud auth list
      - name: Project check
        run: gcloud projects describe $PROJECT_ID --format='value(projectNumber)'
      - name: Cloud Run list
        run: gcloud run services list --region=${{ env.REGION }} || true
      - name: Artifact Registry list
        run: gcloud artifacts repositories list --location=${{ env.REGION }} || true
