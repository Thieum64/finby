name: Deploy Single Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name to deploy (e.g., svc-authz, api-gateway)'
        required: true
        type: choice
        options:
          - svc-authz
          - svc-shops
          - svc-requests
          - svc-preview
          - svc-ia-diff
          - svc-quality
          - svc-billing
          - svc-notify
          - svc-admin
          - api-gateway

permissions:
  contents: read
  id-token: write
  packages: write

concurrency:
  group: deploy-${{ inputs.service }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: europe-west1-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'hyperush-dev-250930115246' }}
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}
  BASE_IMAGE: europe-west1-docker.pkg.dev/hyperush-dev-250930115246/services/base:latest

jobs:
  deploy:
    name: Deploy ${{ inputs.service }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Pull Base Image
        run: docker pull ${{ env.BASE_IMAGE }}

      - name: Local Smoke Test (BLOCKING)
        id: smoke
        run: |
          echo "ðŸ”¨ Building service image locally for smoke test..."
          docker build \
            -f packages/docker/service.Dockerfile \
            --build-arg SERVICE=apps/${{ inputs.service }} \
            --build-arg BASE_IMAGE=${{ env.BASE_IMAGE }} \
            -t smoketest:${{ github.sha }} \
            .

          echo "ðŸ§ª Running smoke test..."
          chmod +x scripts/smoke.sh
          if ./scripts/smoke.sh smoketest:${{ github.sha }}; then
            echo "âœ… SMOKE TEST PASSED"
          else
            echo "âŒ SMOKE TEST FAILED - Container failed to start or respond to /healthz"
            echo "smoke_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "smoke_passed=true" >> $GITHUB_OUTPUT

      - name: Build and Push Service Image via Cloud Build
        if: steps.smoke.outputs.smoke_passed == 'true'
        id: build
        run: |
          IMAGE_SHA="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ inputs.service }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ inputs.service }}:latest"

          cat > /tmp/cloudbuild.yaml <<'EOF'
          steps:
            - name: 'gcr.io/cloud-builders/docker'
              args:
                - 'build'
                - '-f'
                - 'packages/docker/service.Dockerfile'
                - '--build-arg'
                - 'SERVICE=apps/${_SERVICE}'
                - '--build-arg'
                - 'BASE_IMAGE=${_BASE_IMAGE}'
                - '-t'
                - '${_IMAGE_SHA}'
                - '-t'
                - '${_IMAGE_LATEST}'
                - '.'
          images:
            - '${_IMAGE_SHA}'
            - '${_IMAGE_LATEST}'
          options:
            logging: CLOUD_LOGGING_ONLY
          EOF

          echo "ðŸ“¦ Submitting Cloud Build..."
          BUILD_ID=$(gcloud builds submit . \
            --region=${{ env.REGION }} \
            --config=/tmp/cloudbuild.yaml \
            --substitutions=_SERVICE=${{ inputs.service }},_IMAGE_SHA="${IMAGE_SHA}",_IMAGE_LATEST="${IMAGE_LATEST}",_BASE_IMAGE="${{ env.BASE_IMAGE }}" \
            --format="value(id)")

          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "â³ Build ID: $BUILD_ID"

          # Wait for build (max 10min)
          timeout=600
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            STATUS=$(gcloud builds describe "$BUILD_ID" --region=${{ env.REGION }} --format="value(status)")
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Build SUCCESS"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build FAILED: $STATUS"
              gcloud builds log "$BUILD_ID" --region=${{ env.REGION }} | tail -100
              exit 1
            fi
            sleep 10
            elapsed=$((elapsed + 10))
          done

          # Get digest
          DIGEST=$(gcloud builds describe "$BUILD_ID" --region=${{ env.REGION }} --format="value(results.images[0].digest)")
          IMAGE_DIGEST="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/services/${{ inputs.service }}@${DIGEST}"

          echo "IMAGE_URI_DIGEST=$IMAGE_DIGEST" >> $GITHUB_ENV
          echo "ðŸ“¦ Image: $IMAGE_DIGEST"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy Service with Terraform
        working-directory: infra/terraform/services/${{ inputs.service }}
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_runtime_service_account: runtime-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
          TF_VAR_image: ${{ env.IMAGE_URI_DIGEST }}
        run: |
          terraform init -lock-timeout=10m
          terraform plan -lock-timeout=10m -out=service-tfplan
          terraform apply -auto-approve -lock-timeout=10m service-tfplan

      - name: Get Service URL
        working-directory: infra/terraform/services/${{ inputs.service }}
        run: |
          SERVICE_URL=$(terraform output -raw service_url 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            SERVICE_URL=$(gcloud run services describe ${{ inputs.service }} \
              --region=${{ env.REGION }} \
              --format="value(status.url)")
          fi
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "ðŸŒ Service URL: $SERVICE_URL"

      - name: Health Check (Single Attempt)
        run: |
          echo "ðŸ¥ Health checking ${{ env.SERVICE_URL }}/healthz"
          if curl -fsS "${{ env.SERVICE_URL }}/healthz" --max-time 10; then
            echo "âœ… Health check PASSED"
          else
            echo "âŒ Health check FAILED"
            echo "Checking Cloud Run service status..."
            gcloud run services describe ${{ inputs.service }} \
              --region=${{ env.REGION }} \
              --format="yaml(status.conditions)"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ env.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_URI_DIGEST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ env.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
