name: Deploy Single Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name to deploy (e.g., svc-authz, api-gateway)'
        required: true
        type: choice
        options:
          - svc-authz
          - svc-shops
          - svc-requests
          - svc-preview
          - svc-ia-diff
          - svc-quality
          - svc-billing
          - svc-notify
          - svc-admin
          - api-gateway

permissions:
  contents: read
  id-token: write

env:
  REGISTRY: europe-west1-docker.pkg.dev
  AR_REPO: services
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}

jobs:
  deploy:
    name: Deploy ${{ inputs.service }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.15.9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared libraries
        continue-on-error: true
        run: pnpm -r --filter "./packages/**" build

      - name: Build Service
        run: pnpm --filter=@hyperush/${{ inputs.service }} build

      - name: Preflight local docker build (no push)
        continue-on-error: true
        run: |
          docker build \
            -f packages/docker/node-pnpm.Dockerfile \
            --build-arg SERVICE=apps/${{ inputs.service }} \
            -t preflight:${{ inputs.service }} .

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: BUILD AND PUSH CONTAINER IMAGE VIA CLOUD BUILD
        working-directory: ${{ github.workspace }}
        run: |
          IMAGE_URI="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ inputs.service }}:${{ github.sha }}"
          IMAGE_URI_LATEST="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ inputs.service }}:latest"

          # Create cloudbuild.yaml config file
          cat > /tmp/cloudbuild.yaml << 'EOF'
          steps:
          - name: 'gcr.io/cloud-builders/docker'
            args: ['build', '-f', 'packages/docker/node-pnpm.Dockerfile', '--build-arg', 'SERVICE=apps/${_SERVICE}', '-t', '${_IMAGE_SHA}', '-t', '${_IMAGE_LATEST}', '.']
          images:
          - '${_IMAGE_SHA}'
          - '${_IMAGE_LATEST}'
          EOF

          # Reset BUILD_ID env so subsequent steps don't reuse an old value
          echo "BUILD_ID=" >> $GITHUB_ENV

          # Submit build from workspace root with explicit config
          echo "ðŸ“‹ Building from $GITHUB_WORKSPACE with Cloud Build..."
          BUILD_ID=$(gcloud builds submit "$GITHUB_WORKSPACE" \
            --project "${{ vars.GCP_PROJECT_ID }}" \
            --region "$REGION" \
            --config /tmp/cloudbuild.yaml \
            --substitutions _SERVICE=${{ inputs.service }},_IMAGE_SHA=$IMAGE_URI,_IMAGE_LATEST=$IMAGE_URI_LATEST \
            --async --format="value(id)")

          echo "â³ Build ID: $BUILD_ID - Waiting for completion..."
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

          # Wait for build completion
          while true; do
            STATUS=$(gcloud builds describe "$BUILD_ID" --region="$REGION" --format="value(status)")
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Build completed successfully"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              exit 1
            else
              echo "â³ Build still running..."
              sleep 10
            fi
          done

          # Get actual digest from Cloud Build results
          DIGEST=$(gcloud builds describe "$BUILD_ID" --region="$REGION" --format="value(results.images[0].digest)")
          if [ -z "$DIGEST" ]; then
            DIGEST=$(gcloud builds describe "$BUILD_ID" --region="$REGION" --format="value(results.images[1].digest)")
          fi
          if [ -z "$DIGEST" ]; then
            echo "âŒ Failed to get digest from build results"
            exit 1
          fi

          # Construct image URIs
          IMAGE_URI_SHA="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ inputs.service }}:${{ github.sha }}"
          IMAGE_URI_LATEST="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ inputs.service }}:latest"
          IMAGE_URI_DIGEST="${{ env.REGISTRY }}/${{ vars.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ inputs.service }}@${DIGEST}"

          echo "ðŸ“¦ Image URIs:"
          echo "  SHA: $IMAGE_URI_SHA"
          echo "  Latest: $IMAGE_URI_LATEST"
          echo "  Digest: $IMAGE_URI_DIGEST"

          # Export to environment
          echo "IMAGE_URI_SHA=$IMAGE_URI_SHA" >> $GITHUB_ENV
          echo "IMAGE_URI_LATEST=$IMAGE_URI_LATEST" >> $GITHUB_ENV
          echo "IMAGE_URI_DIGEST=$IMAGE_URI_DIGEST" >> $GITHUB_ENV
          echo "IMAGE_DIGEST=$DIGEST" >> $GITHUB_ENV

      - name: Dump Cloud Build details
        if: always()
        env:
          BUILD_ID: ${{ env.BUILD_ID }}
        run: |
          if [ -z "$BUILD_ID" ]; then
            echo "No BUILD_ID captured."
            exit 0
          fi
          echo "Build ID: $BUILD_ID"
          gcloud builds describe "$BUILD_ID" --region "$REGION" --format='value(status,statusDetail,logUrl)'
          echo "----- tail of Cloud Build logs -----"
          gcloud builds log "$BUILD_ID" --region "$REGION" | tail -n 300 || true

      - name: Setup Terraform for Service
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Deploy Service with Terraform
        working-directory: infra/terraform/services/${{ inputs.service }}
        env:
          TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ vars.GCP_REGION || 'europe-west1' }}
          TF_VAR_runtime_service_account: runtime-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          TF_VAR_image: ${{ env.IMAGE_URI_DIGEST }}
        run: |
          terraform init -lock-timeout=10m
          terraform plan -lock-timeout=10m -out=service-tfplan
          terraform apply -auto-approve -lock-timeout=10m service-tfplan

      - name: Idempotence Check
        working-directory: infra/terraform/services/${{ inputs.service }}
        env:
          TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ vars.GCP_REGION || 'europe-west1' }}
          TF_VAR_runtime_service_account: runtime-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          TF_VAR_image: ${{ env.IMAGE_URI_DIGEST }}
        run: |
          echo "ðŸ” Checking idempotence - should show 0 changes"
          terraform plan -lock-timeout=10m -detailed-exitcode
          if [ $? -eq 0 ]; then
            echo "âœ… Idempotence verified - no changes needed"
          else
            echo "âŒ Idempotence failed - infrastructure drift detected"
            exit 1
          fi

      - name: Get Service URL and Health Check
        working-directory: infra/terraform/services/${{ inputs.service }}
        run: |
          SERVICE_URL=$(terraform output -raw service_url)
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

          # Health check with 30 retries
          echo "ðŸ¥ Health checking ${{ inputs.service }} at $SERVICE_URL/healthz"
          for i in {1..30}; do
            if curl -fsS "$SERVICE_URL/healthz" --max-time 10; then
              echo ""
              echo "âœ… Health check passed for ${{ inputs.service }}"
              exit 0
            fi
            echo "Health check attempt $i/30 failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed for ${{ inputs.service }} after 30 attempts"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary for ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${SERVICE_URL:-Not available}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Digest**: ${IMAGE_DIGEST:-Not available}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${BUILD_ID:-Not available}" >> $GITHUB_STEP_SUMMARY
