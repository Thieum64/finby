name: svc-api-gateway CI/CD (dev)
on:
  workflow_dispatch:
  push:
    branches: ['main']
    paths:
      - 'apps/svc-api-gateway/**'
      - '.github/workflows/svc-api-gateway-ci.yml'
permissions:
  id-token: write
  contents: read
env:
  PROJECT_ID: hyperush-dev-250930115246
  PROJECT_NUMBER: 443512026283
  REGION: europe-west1
  REPO: europe-west1-docker.pkg.dev/hyperush-dev-250930115246/hp-dev
  IMAGE_NAME: svc-api-gateway
  TF_DIR: infra/terraform/environments/dev
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Auth to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: deploy-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
      - name: Build & Push (Cloud Build)
        working-directory: apps/svc-api-gateway
        run: |
          TAG="${GITHUB_SHA::12}"
          FULL_IMAGE="${REPO}/${IMAGE_NAME}:${TAG}"
          gcloud builds submit --tag "${FULL_IMAGE}" .
          BUILD_ID=$(gcloud builds list --format='value(ID)' --filter='createTime>=-5m' --limit=1)
          echo "Cloud Build logs: $(gcloud builds describe $BUILD_ID --format='value(logUrl)')"
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_ENV
      - name: Terraform init/plan/apply (dev)
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform --version
          terraform init -input=false
          terraform plan -input=false -out=tfplan -var="svc_api_gateway_image=${FULL_IMAGE}"
          terraform apply -input=false -auto-approve tfplan
      - name: Smoke test /health & E2E trace test
        working-directory: ${{ env.TF_DIR }}
        env:
          GCP_PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          URL=$(terraform output -raw svc_api_gateway_url)
          echo "Service URL: ${URL}"

          # Health check test
          echo "=== Health Check Test ==="
          for i in {1..10}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health")
            if [ "$code" = "200" ]; then
              echo "‚úÖ Health check OK (200)"
              break
            fi
            sleep 3
            if [ $i -eq 10 ]; then
              echo "‚ùå Health check failed"; curl -i "${URL}/health" || true; exit 1
            fi
          done

          # E2E Trace test
          echo "=== E2E Trace Test ==="
          sleep 5  # Allow OTel to initialize
          TRACE_RESPONSE=$(curl -s "${URL}/v1/trace-test")
          echo "Trace test response: ${TRACE_RESPONSE}"

          # Extract trace URL from response
          TRACE_URL=$(echo "${TRACE_RESPONSE}" | jq -r '.trace.traceUrl // empty')
          if [ -n "${TRACE_URL}" ] && [ "${TRACE_URL}" != "null" ]; then
            echo "‚úÖ E2E Trace test successful!"
            echo "üîç View trace: ${TRACE_URL}"
            echo "trace_url=${TRACE_URL}" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Trace URL not found in response, but service is responding"
            echo "This may be normal if OTel is still initializing"
          fi

          # Test API Gateway routing functionality
          echo "=== API Gateway Routing Test ==="

          # Test /api/v1/status endpoint
          STATUS_RESPONSE=$(curl -s "${URL}/api/v1/status")
          echo "Status response: ${STATUS_RESPONSE}"

          # Test /auth/** routing to svc-authz (should proxy to authz service)
          AUTH_HEALTH=$(curl -s "${URL}/auth/health" || echo "failed")
          if [[ "$AUTH_HEALTH" == *"svc-authz"* ]]; then
            echo "‚úÖ API Gateway routing to /auth/** works!"
          else
            echo "‚ö†Ô∏è  API Gateway routing to /auth/** may need adjustment"
            echo "Response: ${AUTH_HEALTH}"
          fi
