name: WIF Security Test (Temporary)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - non-main

permissions:
  contents: read
  id-token: write

jobs:
  wif-test-main:
    name: WIF Test on Main Branch
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'main'

    steps:
      - name: Test WIF Auth on Main Branch
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Verify GCP Access
        run: |
          echo "âœ… WIF Auth successful on main branch"
          gcloud projects describe hyperush-dev
          echo "## âœ… WIF Test Results (Main Branch)" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Access Check**: PASSED" >> $GITHUB_STEP_SUMMARY

  wif-test-non-main:
    name: WIF Test on Non-Main Branch (Should Fail)
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'non-main'

    steps:
      - name: Force Non-Main Context
        run: |
          echo "ðŸ” Testing WIF auth failure on non-main context"
          echo "This should fail due to WIF branch restriction"

      - name: Attempt WIF Auth (Expected to Fail)
        id: auth_attempt
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDP }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Verify Auth Failed as Expected
        run: |
          if [ "${{ steps.auth_attempt.outcome }}" = "failure" ]; then
            echo "âœ… WIF properly restricted - auth failed on non-main as expected"
            echo "## âœ… WIF Security Test Results (Non-Main)" >> $GITHUB_STEP_SUMMARY
            echo "- **Auth Status**: FAILED (as expected)" >> $GITHUB_STEP_SUMMARY
            echo "- **Security**: PROPERLY RESTRICTED" >> $GITHUB_STEP_SUMMARY
            echo "- **Test Result**: PASSED" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ SECURITY ISSUE: WIF auth succeeded on non-main branch!"
            echo "## âŒ WIF Security Test FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- **Auth Status**: SUCCEEDED (SECURITY RISK)" >> $GITHUB_STEP_SUMMARY
            echo "- **Issue**: WIF not properly restricted to main branch" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
