name: svc-authz CI/CD (dev)
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "apps/svc-authz/**"
      - ".github/workflows/svc-authz-ci.yml"
permissions:
  id-token: write
  contents: read
env:
  PROJECT_ID: hyperush-dev-250930115246
  PROJECT_NUMBER: 443512026283
  REGION: europe-west1
  REPO: europe-west1-docker.pkg.dev/hyperush-dev-250930115246/hp-dev
  IMAGE_NAME: svc-authz
  TF_DIR: infra/terraform/envs/dev
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Auth to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: deploy-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - name: Build & Push (Cloud Build)
        working-directory: apps/svc-authz
        run: |
          TAG="${GITHUB_SHA::12}"
          FULL_IMAGE="${REPO}/${IMAGE_NAME}:${TAG}"
          gcloud builds submit --tag "${FULL_IMAGE}" .
          BUILD_ID=$(gcloud builds list --format='value(ID)' --filter='createTime>=-5m' --limit=1)
          echo "Cloud Build logs: $(gcloud builds describe $BUILD_ID --format='value(logUrl)')"
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_ENV
      - name: Terraform init/plan/apply (dev)
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform --version
          terraform init -input=false
          terraform plan -input=false -out=tfplan -var="svc_authz_image=${FULL_IMAGE}"
          terraform apply -input=false -auto-approve tfplan
      - name: Smoke test /health
        working-directory: ${{ env.TF_DIR }}
        run: |
          URL=$(terraform output -raw svc_authz_url)
          echo "URL=${URL}"
          for i in {1..10}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health")
            if [ "$code" = "200" ]; then
              echo "OK (200)"; exit 0
            fi
            sleep 3
          done
          echo "Health check failed"; curl -i "${URL}/health" || true; exit 1